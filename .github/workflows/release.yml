name: üõ†Ô∏è CI (Release)

on:
  workflow_run:
    workflows:
      - 'ü´∏üèª CI (Push)'
    branches:
      - main
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: üïµüèª Lint Workflow
    uses: ./.github/workflows/_lint.yml
  release:
    name: üöÄ Release
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ‚öôÔ∏è Release Please Config
        id: release-please-config
        run: |
          if [ -f .github/release-please-config.json ]; then
              echo "config-file=.github/release-please-config.json" >> $GITHUB_OUTPUT
              [ -f .github/release-please-manifest.json ] &&
              echo "manifest-file=.github/release-please-manifest.json" >> $GITHUB_OUTPUT
              [ -f .github/.release-please-manifest.json ] &&
              echo "manifest-file=.github/.release-please-manifest.json" >> $GITHUB_OUTPUT
          else
              echo "release-type=rust" >> $GITHUB_OUTPUT
          fi
      - name: üôè Release Please
        id: release-please
        uses: googleapis/release-please-action@v4
        with:
          config-file: ${{ steps.release-please-config.outputs.config-file }}
          release-type: ${{ steps.release-please-config.outputs.release-type }}
          manifest-file: ${{ steps.release-please-config.outputs.manifest-file }}
      - name: ü¶æ Build GitPower
        if: ${{ steps.release-please.outputs.release_created }}
        uses: goreleaser/goreleaser-action@v6
        with:
          args: release --clean --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          TAG: ${{ steps.release-please.outputs.tag_name }}
